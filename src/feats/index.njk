---
title: General Feats
layout: layouts/sidebar.njk
---

<div class="stack">
  <h2>General Feats</h2>
  <p>
    As you level up, you can choose to take class feats or general feats. Below
    are the general feats that you can choose. You can choose each feat only
    once, and you must meet the level requirements to take them.
  </p>

  {% for feat in feats %}
    <div>
      <div class="stack" style="--stack-space: 0.5rem">
        <h4>
          {{ feat.Name }}
        </h4>
        <p>
          <small>
            Level {{ feat.Level }}
          </small>
        </p>
        <p>
          {{ feat.Description }}
        </p>
        <div>
          <button type="button" class="small" data-toggle-feat data-id="{{ feat.id }}" data-level="{{ feat.Level }}" data-name="{{ feat.Name }}" hidden>
            Take This Feat
          </button>
        </div>
      </div>
    </div>
  {% endfor %}

  <div data-class-links hidden>
    <h3>Feats From Other Classes</h3>
    <ul class="list-style:none">
      {% for class in classes %}
        <li>
          <a href="/classes/{{ class.slug }}">
            {{ class.Name }}
          </a>
        </li>
      {% endfor %}
    </ul>
</div>

<script type="module">
  import { getFromDb, addToDb } from '/scripts/db.mjs';

  let character;
  const getCharacter = async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const key = urlParams.has('key') && urlParams.get('key');

    if (!key) {
      return;
    }

    const classLinksWrapper = document.querySelector('[data-class-links]');
    const classLinks = document.querySelectorAll('[data-class-links] a');
    classLinks.forEach((link) => {
      link.href += `?key=${key}`;
    });
    classLinksWrapper.removeAttribute('hidden');

    character = await getFromDb('characters', key);
    const selectableFeats = document.querySelectorAll(`[data-toggle-feat]`);
    selectableFeats.forEach((feat) => {
      const level = Number(feat.dataset.level);
      const id = feat.dataset.id;
      if (level <= character.level) {
        feat.removeAttribute('hidden');
        if (character.feats && character.feats.length && character.feats.includes(id)) {
          feat.textContent = 'Remove This Feat';
          feat.setAttribute('data-is-taken', true);
        } else {
          feat.textContent = 'Take This Feat';
          feat.removeAttribute('data-is-taken');
        }
      }
    });
  };

  const updateCharacter = async (character) => {
    try {
      await addToDb('characters', character);
    } catch (error) {
      console.error(error);
    }
  };

  document.addEventListener('click', async (event) => {
    if (event.target.matches('[data-toggle-feat]')) {
      const id = event.target.dataset.id;
      const isTaken = !!event.target.dataset.isTaken;
      const name = event.target.dataset.name;

      if (isTaken) {
        const index = character.feats.findIndex(feat => feat === id);
        character.feats.splice(index, 1);
      } else {
        if (!character.feats) {
          character.feats = [id];
        } else {
          character.feats.push(id);
        }
      }

      if (name === 'Charm Boost' || name === 'Expert Charm') {
        if (isTaken) {
          character.charm -= 1;
        } else {
          character.charm += 1;
        }
      }

      if (name === 'Cool Boost' || name === 'Expert Cool') {
        if (isTaken) {
          character.cool -= 1;
        } else {
          character.cool += 1;
        }
      }

      if (name === 'Sharp Boost' || name === 'Expert Sharp') {
        if (isTaken) {
          character.sharp -= 1;
        } else {
          character.sharp += 1;
        }
      }

      if (name === 'Tough Boost' || name === 'Expert Tough') {
        if (isTaken) {
          character.tough -= 1;
        } else {
          character.tough += 1;
        }
      }

      if (name === 'Technobabble Boost' || name === 'Expert Technobabble') {
        if (isTaken) {
          character.technobabble -= 1;
        } else {
          character.technobabble += 1;
        }
      }

      if (name === 'Lucky Break') {
        if (isTaken) {
          character.luck -= 1;
        } else {
          character.luck += 1;
        }
      }

      await updateCharacter(character);
    }
  });

  document.addEventListener('item-added', () => {
    getCharacter();
  });

  getCharacter();
</script>
